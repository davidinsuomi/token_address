<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
    <style>
        #customers  {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        #customers td, #customers th {
            border: 1px solid;
            border-color : #dddddd;
            padding: 8px;
            text-align:  center;
            border-bottom: 1px solid #ddd;
        }

       #customers tr:nth-child(even){background-color: #f9f9f9;}

        #customers tr:hover {background-color: #ddd;}

        #customers th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: center;
        }
    </style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', {packages: ['corechart']});
        google.charts.setOnLoadCallback(func_http_get);
        function get_change(current,midnight){
            var change;
            if(current - midnight >=0){
               change = (current - midnight) * 100 / (midnight) +"%";
            }else{
                change = "-" + (midnight - current) * 100 / (midnight) +"%";
            }
            return change;
        }
        function get_image_clicked(token){
           console.log(token +"clicked \n");
        }
        function create_table(source){
            var newTable = document.createElement('table');
            newTable.id = "customers";
            var tableHeadingRow = document.createElement('tr');
            var tableHeader_0 = document.createElement('th');
            var tableHeader_1 = document.createElement('th');
            var tableHeader_2 = document.createElement('th');
            var tableHeader_3 = document.createElement('th');
            var tableHeader_4 = document.createElement('th');
            var header_0 = document.createTextNode('');
            var header_1 = document.createTextNode('Name');
            var header_2 = document.createTextNode('Number of addresses');
            var header_3 = document.createTextNode('Change');
            var header_4 = document.createTextNode('Address graph(1d)');
            tableHeader_0.appendChild(header_0);
            tableHeader_1.appendChild(header_1);
            tableHeader_2.appendChild(header_2);
            tableHeader_3.appendChild(header_3);
            tableHeader_4.appendChild(header_4);
            tableHeadingRow.appendChild(tableHeader_0);
            tableHeadingRow.appendChild(tableHeader_1);
            tableHeadingRow.appendChild(tableHeader_2);
            tableHeadingRow.appendChild(tableHeader_3);
            tableHeadingRow.appendChild(tableHeader_4);
            newTable.appendChild(tableHeadingRow);

            for(i = 0; i < source.length; i++){
                var tableRow = document.createElement('tr');
                var tableData_0 = document.createElement('img');
                var tableData_1 = document.createElement('td');
                tableData_1.width = "20%";
                var tableData_2 = document.createElement('td');
                tableData_1.width = "10%";
                var tableData_3 = document.createElement('td');
                tableData_1.width = "30%";
                var tableData_4 = document.createElement('td');
                tableData_1.width = "40%";
                tableData_0.src = "/pic/" + source[i].name +".png";
                tableData_0.alt = source[i].name;
                tableData_0.align = "middle";
                //create description header.
                var table_data_head_5 = document.createElement('h5');
                var table_data_head_href = document.createElement('a');
                var head_5_href = document.createAttribute('href');
                head_5_href.value = source[i].url;
                table_data_head_href.setAttributeNode(head_5_href);

                table_data_head_href.textContent = source[i].name;
                table_data_head_5.appendChild(table_data_head_href);
                tableData_1.appendChild(table_data_head_5);
                console.log(tableData_1.innerHTML) ;
                tableData_2.textContent = source[i].address_num;
                tableData_3.textContent = get_change(source[i].address_num, source[i].midnight_address);
                if(parseInt(tableData_3.textContent) >= 0){
                    tableData_3.style.color = "#00810a";
                }else{
                    tableData_3.style.color = "#ff0000";
                }
                tableData_4.id =  "img" +i;
                tableData_4.alt =  source[i].name;
                tableData_4.style.cursor=  "pointer";
                tableData_4.onclick =  function() {
                    window.open("token_address.html?token="+ this.alt,'_blank');
                    //alert(this.alt);
                }
                tableRow.appendChild(tableData_0);
                tableRow.appendChild(tableData_1);
                tableRow.appendChild(tableData_2);
                tableRow.appendChild(tableData_3);
                tableRow.appendChild(tableData_4);
                newTable.appendChild(tableRow);
            }
            document.body.appendChild(newTable);
        }
        function create_pic_trend(points, index)
        {
            var num = points.length;
            var source_data = [];
            for(var i=0; i < num; i++){
                var time = new Date(points[i][0] * 1000);
                var address_num = Number(points[i][1]);
                //time = new Date(time.toDateString());
                console.log(time);
                var row = [time, address_num];
                source_data.push(row);
            }
            console.log("dump source data\n");
            console.log(source_data);
            var data = new google.visualization.DataTable();
            data.addColumn('date', 'X');
            data.addColumn('number', 'address');


            data.addRows(source_data);
            var options = {
                width: 240,
                height: 80,
                legend: {position: 'none'}
                /*
                hAxis: {
                    title: 'Time',
                    format: 'dd/MM/yyyy HH:mm'
                },
                vAxis: {
                    title: 'num of address'
                }
                */
            };

            var div_id = "img" + index;
            var chart_div = document.getElementById(div_id);
            var chart = new google.visualization.LineChart(chart_div);
            var dateFormatter = new google.visualization.DateFormat({pattern: 'dd/MM/yyyy HH:mm'});
            dateFormatter.format(data, 0);

            google.visualization.events.addListener(chart, 'ready', function () {
                chart_div.innerHTML = '<img src="' + chart.getImageURI() + '">';
                console.log(chart_div.innerHTML);
            });

            chart.draw(data, options);

        }
        function draw(source){
            var source = JSON.parse(source);
            console.log(source);
            var num = source.length;
            console.log(num);
            create_table(source);

            for(i = 0; i < source.length; i++){
                var points = source[i].points;
                create_pic_trend(points, i);
            }
        }
        function func_http_get(){
            if (window.XMLHttpRequest) {
                // code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp=new XMLHttpRequest();
            } else { // code for IE6, IE5
                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange=function() {
                if (this.readyState==4 && this.status==200) {
                    draw(this.responseText);
                }
            }
            xmlhttp.open("GET","get_tables.php",true);
            xmlhttp.send();
        }
    </script>
</head>
<body>
<h2 id="header_1" align="center"></h2>
<div id="chart_div"></div>

</body>
</html>